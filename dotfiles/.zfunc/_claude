#compdef claude

# Zsh completion for the Claude Code CLI
# https://docs.anthropic.com/en/docs/claude-code

_claude_commands() {
  local -a commands=(
    'doctor:Check the health of your Claude Code auto-updater'
    'install:Install Claude Code native build'
    'mcp:Configure and manage MCP servers'
    'plugin:Manage Claude Code plugins'
    'setup-token:Set up a long-lived authentication token'
    'update:Check for updates and install if available'
  )
  _describe -t commands 'claude command' commands
}

_claude_mcp_commands() {
  local -a commands=(
    'add:Add an MCP server (stdio or SSE)'
    'add-from-claude-desktop:Import MCP servers from Claude Desktop'
    'add-json:Add an MCP server with a JSON string'
    'get:Get details about an MCP server'
    'help:Display help for command'
    'list:List configured MCP servers'
    'remove:Remove an MCP server'
    'reset-project-choices:Reset approved/rejected project-scoped servers'
    'serve:Start the Claude Code MCP server'
  )
  _describe -t commands 'mcp command' commands
}

_claude_plugin_commands() {
  local -a commands=(
    'disable:Disable an enabled plugin'
    'enable:Enable a disabled plugin'
    'help:Display help for command'
    'install:Install a plugin from available marketplaces'
    'list:List installed plugins'
    'marketplace:Manage Claude Code marketplaces'
    'uninstall:Uninstall an installed plugin'
    'update:Update a plugin to the latest version'
    'validate:Validate a plugin or marketplace manifest'
  )
  _describe -t commands 'plugin command' commands
}

_claude() {
  local curcontext="$curcontext" state line
  typeset -A opt_args

  _arguments -C \
    '--add-dir[Additional directories to allow tool access to]:directories:_files -/' \
    '--agent[Agent for the current session]:agent:' \
    '--agents[JSON object defining custom agents]:json:' \
    '--allow-dangerously-skip-permissions[Enable bypassing all permission checks as an option]' \
    '(--allowedTools --allowed-tools)'{--allowedTools,--allowed-tools}'[Tool names to allow]:tools:' \
    '--append-system-prompt[Append to the default system prompt]:prompt:' \
    '--betas[Beta headers to include in API requests]:betas:' \
    '--chrome[Enable Claude in Chrome integration]' \
    '(-c --continue)'{-c,--continue}'[Continue the most recent conversation]' \
    '--dangerously-skip-permissions[Bypass all permission checks]' \
    '(-d --debug)'{-d,--debug}'[Enable debug mode with optional category filtering]:filter:' \
    '--debug-file[Write debug logs to a specific file path]:path:_files' \
    '--disable-slash-commands[Disable all skills]' \
    '(--disallowedTools --disallowed-tools)'{--disallowedTools,--disallowed-tools}'[Tool names to deny]:tools:' \
    '--fallback-model[Fallback model when default is overloaded]:model:' \
    '--file[File resources to download at startup]:specs:' \
    '--fork-session[Create a new session ID instead of reusing the original]' \
    '--from-pr[Resume a session linked to a PR]:pr:' \
    '(-h --help)'{-h,--help}'[Display help for command]' \
    '--ide[Automatically connect to IDE on startup]' \
    '--include-partial-messages[Include partial message chunks as they arrive]' \
    '--input-format[Input format]:format:(text stream-json)' \
    '--json-schema[JSON Schema for structured output validation]:schema:' \
    '--max-budget-usd[Maximum dollar amount to spend on API calls]:amount:' \
    '*--mcp-config[Load MCP servers from JSON files or strings]:config:_files' \
    '--mcp-debug[Enable MCP debug mode]' \
    '--model[Model for the current session]:model:(haiku sonnet opus)' \
    '--no-chrome[Disable Claude in Chrome integration]' \
    '--no-session-persistence[Disable session persistence]' \
    '--output-format[Output format]:format:(text json stream-json)' \
    '--permission-mode[Permission mode for the session]:mode:(acceptEdits bypassPermissions default delegate dontAsk plan)' \
    '*--plugin-dir[Load plugins from directories]:path:_files -/' \
    '(-p --print)'{-p,--print}'[Print response and exit]' \
    '--replay-user-messages[Re-emit user messages from stdin back on stdout]' \
    '(-r --resume)'{-r,--resume}'[Resume a conversation by session ID]:session:' \
    '--session-id[Use a specific session ID]:uuid:' \
    '--setting-sources[Comma-separated list of setting sources]:sources:' \
    '--settings[Path to settings JSON file or JSON string]:file-or-json:_files' \
    '--strict-mcp-config[Only use MCP servers from --mcp-config]' \
    '--system-prompt[System prompt for the session]:prompt:' \
    '*--tools[Specify available tools]:tools:' \
    '--verbose[Override verbose mode setting]' \
    '(-v --version)'{-v,--version}'[Output the version number]' \
    '1: :_claude_commands' \
    '*::arg:->args'

  case $state in
    args)
      case $line[1] in
        install)
          _arguments \
            '1:target:(stable latest)'
          ;;
        mcp)
          _arguments -C \
            '1:mcp subcommand:_claude_mcp_commands' \
            '*::arg:->mcp_args'
          case $state in
            mcp_args)
              case $line[1] in
                add)
                  _arguments \
                    '(-s --scope)'{-s,--scope}'[Configuration scope]:scope:(local project user)' \
                    '(-t --transport)'{-t,--transport}'[Transport type]:transport:(stdio sse)' \
                    '(-e --env)'{-e,--env}'[Environment variables (KEY=val)]:env:' \
                    '--header[HTTP headers for SSE]:header:' \
                    '1:name:' \
                    '*:command or url:'
                  ;;
                add-json)
                  _arguments \
                    '(-s --scope)'{-s,--scope}'[Configuration scope]:scope:(local project user)' \
                    '1:name:' \
                    '2:json:'
                  ;;
                add-from-claude-desktop)
                  _arguments \
                    '(-s --scope)'{-s,--scope}'[Configuration scope]:scope:(local project user)'
                  ;;
                get)
                  _arguments '1:name:'
                  ;;
                remove)
                  _arguments \
                    '(-s --scope)'{-s,--scope}'[Configuration scope]:scope:(local project user)' \
                    '1:name:'
                  ;;
                serve)
                  _arguments \
                    '--port[Port to listen on]:port:' \
                    '--host[Host to bind to]:host:'
                  ;;
                reset-project-choices|list|help)
                  ;;
              esac
              ;;
          esac
          ;;
        plugin)
          _arguments -C \
            '1:plugin subcommand:_claude_plugin_commands' \
            '*::arg:->plugin_args'
          case $state in
            plugin_args)
              case $line[1] in
                disable)
                  _arguments \
                    '(-s --scope)'{-s,--scope}'[Configuration scope]:scope:(local project user)' \
                    '1::plugin:'
                  ;;
                enable)
                  _arguments \
                    '(-s --scope)'{-s,--scope}'[Configuration scope]:scope:(local project user)' \
                    '1:plugin:'
                  ;;
                install|i)
                  _arguments \
                    '(-s --scope)'{-s,--scope}'[Configuration scope]:scope:(local project user)' \
                    '1:plugin:'
                  ;;
                list)
                  _arguments \
                    '(-s --scope)'{-s,--scope}'[Configuration scope]:scope:(local project user)'
                  ;;
                uninstall|remove)
                  _arguments \
                    '(-s --scope)'{-s,--scope}'[Configuration scope]:scope:(local project user)' \
                    '1:plugin:'
                  ;;
                update)
                  _arguments \
                    '(-s --scope)'{-s,--scope}'[Configuration scope]:scope:(local project user)' \
                    '1:plugin:'
                  ;;
                validate)
                  _arguments \
                    '(-s --scope)'{-s,--scope}'[Configuration scope]:scope:(local project user)' \
                    '1:path:_files'
                  ;;
                marketplace|help)
                  ;;
              esac
              ;;
          esac
          ;;
      esac
      ;;
  esac
}

_claude "$@"
